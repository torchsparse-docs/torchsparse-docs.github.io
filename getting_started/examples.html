<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Enabling Inference Optimizations" href="../guides/optimization.html" /><link rel="prev" title="Changes in TorchSparse v2.1" href="changes.html" />
        <link rel="canonical" href="https://torchsparse-docs.github.io/getting_started/examples.html" />

    <!-- Generated with Sphinx 7.0.1 and Furo 2023.05.20 -->
        <title>Examples for TorchSparse v2.1 - TorchSparse documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">TorchSparse  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">TorchSparse  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basic Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Changes in TorchSparse v2.1</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Examples for TorchSparse v2.1</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guides/optimization.html">Enabling Inference Optimizations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/torchsparse.html">torchsparse</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../reference/torchsparse.backbones.html">torchsparse.backbones</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of torchsparse.backbones</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/torchsparse.backbones.modules.html">torchsparse.backbones.modules</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../reference/torchsparse.nn.html">torchsparse.nn</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of torchsparse.nn</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/torchsparse.nn.functional.html">torchsparse.nn.functional</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/torchsparse.nn.modules.html">torchsparse.nn.modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/torchsparse.nn.utils.html">torchsparse.nn.utils</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/torchsparse.utils.html">torchsparse.utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/citation.html">Citation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support/faq.html">Frequently Asked Questions</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="examples-for-torchsparse-v2-1">
<h1>Examples for TorchSparse v2.1<a class="headerlink" href="#examples-for-torchsparse-v2-1" title="Permalink to this heading">#</a></h1>
<p>We also made it easier to integrate our library to other 3D deep learning algorithm frameworks or implementing new models from scratch in TorchSparse v2.1. Here we showcase two examples (<code class="docutils literal notranslate"><span class="pre">mmdetection3d</span></code> integration and implementing models from scratch in <code class="docutils literal notranslate"><span class="pre">spvnas</span></code>):</p>
<section id="mmdetection3d-integration">
<h2>Mmdetection3d integration<a class="headerlink" href="#mmdetection3d-integration" title="Permalink to this heading">#</a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h3>
<p>We present a end-to-end example of TorchSparse v2.1 integration into mmdetection3d in the <a class="reference external" href="https://github.com/mit-han-lab/bevfusion/tree/dev/torchsparsepp_backend">BEVFusion</a> repository. BEVFusion is a multi-modal 3D perception model that takes in both surrounding camera images and LiDAR scans and fuses these information in the shared bird’s-eye-view space. The SparseConv-based LiDAR feature extractor is the key to BEVFusion’s performance, which is well-supported by TorchSparse v2.1.</p>
<p>One may want to pay attention to the following files when investigating our integration, since it might also be helpful for potential TorchSparse integration into other frameworks such as Det3D and OpenPCDet.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mmdet3d/models/backbones/sparse_encoder.py</span></code>: SparseConv model implementation;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mmdet3d/ops/spconv/__init__.py</span></code>: Op registry;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mmdet3d/ops/sparse_block.py</span></code>: SparseConv blocks (e.g. plain residual, bottleneck, etc.);</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tools/convert_checkpoints_to_torchsparse.py</span></code>: checkpoint converter.</p></li>
</ul>
</section>
<section id="deep-dive">
<h3>Deep dive<a class="headerlink" href="#deep-dive" title="Permalink to this heading">#</a></h3>
<p><a class="reference external" href="https://github.com/open-mmlab/mmdetection3d">mmdetection3d</a> is a widely-used codebase for 3D perception tasks. It seamlessly support different benchmarks and state-of-the-art models. All the models and datasets in mmdetection3d can be easily built with a configuration dictionary.</p>
<section id="model-registries">
<h4>Model registries<a class="headerlink" href="#model-registries" title="Permalink to this heading">#</a></h4>
<p>In TorchSparse v2.1, we present a simple way to integrate our APIs into mmdetection3d. One can start from <code class="docutils literal notranslate"><span class="pre">mmdet3d/ops/spconv</span></code>, which provides native support for the SpConv library. After deleting all the files in this directory, one can create a new <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and add the following content:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">from</span> <span class="nn">mmcv.cnn.bricks.registry</span> <span class="kn">import</span> <span class="n">CONV_LAYERS</span><span class="p">,</span> <span class="n">NORM_LAYERS</span>
<span class="kn">from</span> <span class="nn">torch.nn.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>

<span class="k">def</span> <span class="nf">register_torchsparse</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This func registers torchsparse ops.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">torchsparse.nn</span> <span class="kn">import</span> <span class="n">Conv3d</span><span class="p">,</span> <span class="n">BatchNorm</span>

    <span class="n">CONV_LAYERS</span><span class="o">.</span><span class="n">_register_module</span><span class="p">(</span><span class="n">Conv3d</span><span class="p">,</span> <span class="s2">&quot;TorchSparseConv3d&quot;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">NORM_LAYERS</span><span class="o">.</span><span class="n">_register_module</span><span class="p">(</span><span class="n">BatchNorm</span><span class="p">,</span> <span class="s2">&quot;TorchSparseBatchNorm&quot;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">register_torchsparse</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="building-blocks">
<h4>Building blocks<a class="headerlink" href="#building-blocks" title="Permalink to this heading">#</a></h4>
<p>That’s it! When you are defining any <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> in PyTorch, you can construct a TorchSparse v2.1 convolution layer using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mmcv.cnn</span> <span class="kn">import</span> <span class="n">build_conv_layer</span>
<span class="n">conv_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;TorchSparseConv3d&quot;</span><span class="p">)</span>
<span class="n">layer</span> <span class="o">=</span> <span class="n">build_conv_layer</span><span class="p">(</span>
    <span class="n">conv_cfg</span><span class="p">,</span>
    <span class="n">in_channels</span><span class="p">,</span>
    <span class="n">out_channels</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">build_conv_layer</span></code> is implemented by <a class="reference external" href="https://github.com/open-mmlab/mmcv">mmcv</a>. We do not even need to modify the model registry by ourselves.</p>
<p>Another interesting fact about TorchSparse v2.1 is that one can almost fully reuse existing <code class="docutils literal notranslate"><span class="pre">mmcv</span></code> implementation of 2D CNN building blocks. Here is an example for the plain residual block:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SparseBasicBlock</span><span class="p">(</span><span class="n">BasicBlock</span><span class="p">):</span>

    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inplanes</span><span class="p">,</span>
        <span class="n">planes</span><span class="p">,</span>
        <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">conv_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">norm_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">act_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">BasicBlock</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">inplanes</span><span class="p">,</span>
            <span class="n">planes</span><span class="p">,</span>
            <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
            <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">,</span>
            <span class="n">conv_cfg</span><span class="o">=</span><span class="n">conv_cfg</span><span class="p">,</span>
            <span class="n">norm_cfg</span><span class="o">=</span><span class="n">norm_cfg</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">act_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">act_cfg</span> <span class="o">==</span> <span class="s2">&quot;swish&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">spnn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">spnn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that one only needs to modify the <code class="docutils literal notranslate"><span class="pre">self.relu</span></code> function in the original plain residual block implementation. This is because <code class="docutils literal notranslate"><span class="pre">self.relu</span></code> has to take in <code class="docutils literal notranslate"><span class="pre">torchsparse.SparseTensor</span></code>s. We do not even need to touch the <code class="docutils literal notranslate"><span class="pre">forward</span></code> function of this module thanks to the fact that the forward pass in TorchSparse is identical to that in PyTorch.</p>
</section>
<section id="migrating-from-spconv">
<h4>Migrating from SpConv<a class="headerlink" href="#migrating-from-spconv" title="Permalink to this heading">#</a></h4>
<p>Given that mmdetection3d provides existing implementations for the SpConv backend as well, converting to TorchSparse will not be too difficult. We provide an easy-to-use checkpoint converter <a class="reference external" href="https://github.com/mit-han-lab/bevfusion/tree/dev/torchsparsepp_backend/tools/convert_checkpoints_to_torchsparse.py">here</a> to directly convert SpConv-pretrained models to TorchSparse models. The inference results will be exactly the same after conversion. For model level transformations, all you need to do is to modify the model registry from</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conv_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;SparseConv3d&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>which registers to the SpConv backend to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conv_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;TorchSparseConv3d&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>which corresponds to our backend. Notice that you do not need to specify fields like <code class="docutils literal notranslate"><span class="pre">indice_key</span></code> in SpConv. These fields are automatically handled by TorchSparse v2.1.</p>
</section>
</section>
</section>
<section id="building-models-from-scratch">
<h2>Building models from scratch<a class="headerlink" href="#building-models-from-scratch" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>Overview<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>Alternatively, it is not difficult to build new models from scratch without model registries. We showcase such application in <a class="reference external" href="https://github.com/mit-han-lab/spvnas/tree/dev/torchsparsepp_backend">SPVNAS</a>. SPVNAS is an early work attempting to automatically design efficient architectures for 3D semantic segmentation. If is composed of Sparse Point-Voxel Convolution (SPVConv) layers, which is natively supported by TorchSparse. Here are some example files that one might be interested in when building models from scratch:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">core/models/semantic_kitti/minkunet.py</span></code>: defining the most basic <a class="reference external" href="https://openaccess.thecvf.com/content_CVPR_2019/papers/Choy_4D_Spatio-Temporal_ConvNets_Minkowski_Convolutional_Neural_Networks_CVPR_2019_paper.pdf">MinkowskiUNet</a> (CVPR 2019) architecture;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">core/models/utils.py</span></code>: Updated voxelization / devoxelization implementation in TorchSparse v2.1;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">core/models/semantic_kitti/spvcnn.py</span></code>, <code class="docutils literal notranslate"><span class="pre">core/models/semantic_kitti/spvnas.py</span></code>: Implementation for SPVCNN and SPVNAS.</p></li>
</ul>
</section>
<section id="id2">
<h3>Deep dive<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<p>Implementing new sparse models using TorchSparse v2.1 is incredibly easy.</p>
<section id="pure-sparseconv-models">
<h4>Pure SparseConv models<a class="headerlink" href="#pure-sparseconv-models" title="Permalink to this heading">#</a></h4>
<p>The high-level guideline is that you <strong>do not need to change anything</strong> compared with previous TorchSparse implementation if you are using pure SparseConv-based architectures (like MinkUNet or the SECOND / CenterPoint encoders). The following global flags will help you achieve better speedup or have control over the model’s behavior in downsampling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torchsparse.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>

<span class="c1"># Setting conv mode</span>
<span class="c1"># Available choices are 0, 1, 2, which are optimized for different workloads and achieve close performance to the autotuned configurations</span>
<span class="c1"># 2 is recommended for semantic segmentation</span>

<span class="n">F</span><span class="o">.</span><span class="n">set_conv_mode</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Select the way how kernel maps are constructed.</span>
<span class="c1"># &quot;hashmap&quot; is compatible with MinkowskiEngine and &quot;hashmap_on_the_fly&quot; is compatible with SpConv. </span>
<span class="c1"># The results are not too different using these two but &quot;hashmap_on_the_fly&quot; is slightly faster in most cases.</span>

<span class="n">F</span><span class="o">.</span><span class="n">set_kmap_mode</span><span class="p">(</span><span class="s2">&quot;hashmap&quot;</span><span class="p">)</span>

<span class="c1"># Select the compatible mode for downsampling.</span>
<span class="c1"># Choosing between &quot;spconv&quot; and &quot;minkowski&quot;. </span>
<span class="c1"># The same behavior for kernel_size = stride cases, </span>
<span class="c1"># SpConv gives larger output size when kernel_size &gt; stride.</span>

<span class="n">F</span><span class="o">.</span><span class="n">set_downsample_mode</span><span class="p">(</span><span class="s2">&quot;spconv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: if these fields are not set, they default to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conv_mode</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">kmap_mode</span> <span class="o">=</span> <span class="s2">&quot;hashmap_on_the_fly&quot;</span>
<span class="n">downsample_mode</span> <span class="o">=</span> <span class="s2">&quot;spconv&quot;</span>
</pre></div>
</div>
<p>For some applications like 3D reconstruction, it might be necessary to set downsample mode to “minkowski” to achieve the best performance.</p>
</section>
<section id="spvconv-modifications">
<h4>SPVConv modifications<a class="headerlink" href="#spvconv-modifications" title="Permalink to this heading">#</a></h4>
<p>For modules like SPVConv where voxelization and devoxelization operators are involved, the implementation differs from TorchSparse &lt;= 2.0. We refer the users to the new implementation of <code class="docutils literal notranslate"><span class="pre">core/models/utils.py</span></code> versus the old one in the master branch. In short, the fact that:</p>
<ul class="simple">
<li><p>We change the coordinate representation, moving batch index to the first dimension and always shrink the scale of coordinates after downsampling;</p></li>
<li><p>We deprecate several inefficient hashmap APIs</p></li>
</ul>
<p>requires us to reimplement these operators. But the modifications are straightforward and have been done on our side.</p>
</section>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../guides/optimization.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Enabling Inference Optimizations</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="changes.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Changes in TorchSparse v2.1</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, MIT HAN Lab.
Document author: Xiuyu Li. Modified by: Haotian Tang and Shang Yang.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Examples for TorchSparse v2.1</a><ul>
<li><a class="reference internal" href="#mmdetection3d-integration">Mmdetection3d integration</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#deep-dive">Deep dive</a><ul>
<li><a class="reference internal" href="#model-registries">Model registries</a></li>
<li><a class="reference internal" href="#building-blocks">Building blocks</a></li>
<li><a class="reference internal" href="#migrating-from-spconv">Migrating from SpConv</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#building-models-from-scratch">Building models from scratch</a><ul>
<li><a class="reference internal" href="#id1">Overview</a></li>
<li><a class="reference internal" href="#id2">Deep dive</a><ul>
<li><a class="reference internal" href="#pure-sparseconv-models">Pure SparseConv models</a></li>
<li><a class="reference internal" href="#spvconv-modifications">SPVConv modifications</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>